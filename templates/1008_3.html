<!DOCTYPE html> <!-- Document Type Definition-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- @jaeseung : for TAB -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

    <link href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css"
    rel="stylesheet">
    <link href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"
    rel="stylesheet">
    <link rel="shortcut icon" href="http://rb20.kimsq.co.kr/rb2/layouts/default/assets/ico/favicon.ico">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="d3.legend.js"></script>

    {% load staticfiles %}

    <title>Smart Butler</title>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>

    <!-- Bootstrap -->

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
    integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous">
</script>

<script src="https://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript"
src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
</head>

<body style="background-image: url({% static 'images/back-home.jpg' %});
background-size: cover;
background-repeat: no-repeat;
z-index: -1;">
</body>


<div class="container">

    <div class="row" , style="margin-top: 15px; border: hidden; padding-left: 16px; padding-right:16px; max-height: 77px">
        <!-- 제목부 Smart Butler Reasoner -->
        <div class="jumbotron" style="padding-top: 7px; padding-bottom: 7px; background-color: #222B3A;">
            <!-- HTML은 6단계의 제목을 갖고, <h1> ~ <h6> 단계로 표현됨 -->
            <!-- <h1> Main Title </h1>
                 <h2> Top Level Heading </h2>
                 <h3> Subheading </h3>
                 <h4> Sub-subheading </h4>-->

                 <h2 style="color: aliceblue" align="center">Smart Butler Profile Service Executer</h2>
                 <!-- <p> 요소는 문자의 문단을 포함하기 위한 것; 일반적인 문자 내용을 나타낼 때 많이 사용됨 -->

                 </div>
             </div>

             <div class="row" , style="margin-top: 10px; border: hidden; min-height: 1000px;">


                <!-- @jaeseung : 0. Start from here! -->
                <div class="col-md-7" , style="border: hidden; min-height: 800px;">

                    <!-- @jaeseung : 1. Current -->
                    <div class="row" , style="border: hidden; min-height: 400px;">
                        <div class="col-md-12">
                            <div class="panel"  style="border: none;  opacity: 0.7">
                                <div class="panel-heading" style="background-color: #3D495D; padding-bottom: 4px; border: none">
                                    <p style="color: aliceblue; font-size: 20px"><span class="glyphicon glyphicon-thumbs-up"></span> Context Controller


                                        <select name="userid" style="background-color: #3D495D; font-size: 18px; float: right">>
                                            <option value="selectuser">Select User</option>
                                            <option value="park">Park</option>
                                            <option value="kim">Kim</option>
                                            <option value="choi">Choi</option>
                                        </select>                                
                                    </div>
                        <!-- @jaeseung : Unused Tab 
                        <div class="w3-bar w3-black">
                            <button class="w3-bar-item w3-button tablink w3-red" onclick="openTab(event,'Context1')">Context</button>
                            <button class="w3-bar-item w3-button tablink" onclick="openTab(event,'Context2')">Device</button>
                        </div>
                    -->
                    <div class="panel-body" style="min-height: 350px;max-height: 350px; background-color: #FFFFFF">
                       <!-- @jaeseung : row1 -->
                       <div class = "row">

                        <div class="col-sm-6">
                            <img src="{% static '1008/fall.png' %}" width="100" style="margin-left: 15px;">

                            <div class="btn-group" role="group" style="margin-left: 15px;">
                                <button id="btnGroupDrop1" type="button" 
                                class="btn btn-primary dropdown-toggle" data-toggle="dropdown" 
                                aria-haspopup="true" aria-expanded="false">
                                Season 
                                <span class="caret"></span> </button>
                                <ul class="dropdown-menu">
                                    <li><a href="#">Spring</a></li>
                                    <li><a href="#">Summer</a></li>
                                    <li><a href="#">Fall</a></li>
                                    <li><a href="#">Winter</a></li>
                                </ul> 
                            </div>

                        </div>

                        <div class="col-sm-6">
                            <div class="col-sm-3">
                                <img src="{% static '1008/clock1.png' %}" width="100" >
                            </div>

                            <div class="col-sm-3">
                            </div>    
                        </div>
                    </div>

                    <!-- @jaeseung : row2 -->
                    <div class = "row" style="margin-top: 15px;">

                        <div class="col-sm-6">
                            <img src="{% static '1008/thermometer.png' %}" width="100" >

                            <div class="btn-group" role="group">
                                <button id="btnGroupDrop1" type="button" 
                                class="btn btn-primary dropdown-toggle" data-toggle="dropdown" 
                                aria-haspopup="true" aria-expanded="false">
                                Dropdown 
                                <span class="caret"></span> </button>
                                <ul class="dropdown-menu">
                                    <li><a href="#">Spring</a></li>
                                    <li><a href="#">Summer</a></li>
                                    <li><a href="#">Fall</a></li>
                                    <li><a href="#">Winter</a></li>
                                </ul> 
                            </div>
                        </div>

                        <div class="col-sm-6">
                            <img src="{% static '1008/weekday.png' %}" width="100" style="margin-left: 15px;">


                            <div class="btn-group" role="group" style="margin-left: 15px;">
                                <button id="btnGroupDrop2" type="button" 
                                class="btn btn-primary dropdown-toggle" data-toggle="dropdown" 
                                aria-haspopup="true" aria-expanded="false">
                                Weekdays
                                <span class="caret"></span> </button>
                                <ul class="dropdown-menu">
                                    <li><a href="#">Weekdays</a></li>
                                    <li><a href="#">Weekend</a></li>
                                </ul> 
                            </div>

                        </div>
                    </div>

                    <!-- @jaeseung : row3 -->
                    <div class = "row" style="margin-top: 15px;">
                        <div class="col-sm-6">
                            <div class="col-sm-5">
                                <img src="{% static '1008/micro_dust.png' %}" width="100" >
                            </div>

                            <div class="col-sm-6">

                            </div>
                        </div>
                        <div class="col-sm-6">
                            <img src="{% static '1008/weather_sunny.png' %}" width="100" style="margin-left: 15px;">

                            <div class="btn-group" role="group" style="margin-left: 15px;">
                                <button id="btnGroupDrop1" type="button" 
                                class="btn btn-primary dropdown-toggle" data-toggle="dropdown" 
                                aria-haspopup="true" aria-expanded="false">
                                Weather 
                                <span class="caret"></span> </button>
                                <ul class="dropdown-menu">
                                    <li><a href="#">Sunny</a></li>
                                    <li><a href="#">Cloud</a></li>
                                    <li><a href="#">Rain</a></li>
                                    <li><a href="#">Snow</a></li>
                                    <li><a href="#">Dark</a></li>
                                </ul> 
                            </div>


                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>


    <!-- @jaeseung : 2. Graph -->
    <div class="row" , style="border: hidden; min-height: 400px;">
        <div class="col-md-12">
            <div class="row" , style="border: hidden; min-height: 50px;">
                <div class="col-md-12">
                    <div class="panel" style="border: none; opacity: 0.7; width:652.5px;height:400px;">
                        <div class="panel-heading" style="background-color: #3D495D; padding-bottom: 4px; border: none">
                            <p style="color: aliceblue; font-size: 20px"> <span class="glyphicon glyphicon-sort"></span> User Device Usage Model

                                <button style="background-color: #3D495D; font-size: 18px; float: right"
                                onclick="window.open('http://localhost:9000/popup/','Pop-up Google',
                                    'width=1200,height=500,left=600,top=100,' +
                                    'status=no,toolbar=no,location=no,menubar=no,titlebar=no,scrollbars=yes');">Load Profile
                                </button>

                        <!-- 
                                <div class="custom-file">
                                  <input type="file" class="custom-file-input" id="customFile">
                                  <label class="custom-file-label" for="customFile">Load Profile</label>
                              </div>
                          -->
                      </p>
                                    <!-- @jaeseung : link button test
                                            1. 새창으로 열기
                                            2. 팝업으로 열기
                                    <input type="button" value="Link to Google" onClick="window.open('http://google.com')">
                                -->
                            </div>
                            <div class="panel-body" style="min-height: 300px; padding: 0px; border:none;">
                                <div class="w3-bar w3-black">
                                    <button class="w3-bar-item w3-button tablink w3-red" onclick="openTab(event,'Device1')">AirConditioner</button>
                                    <button class="w3-bar-item w3-button tablink" onclick="openTab(event,'Device2')">AirCleaner</button>
                                    <button class="w3-bar-item w3-button tablink" onclick="openTab(event,'Device3')">Bulb</button>
                                    <button class="w3-bar-item w3-button tablink" onclick="openTab(event,'Device4')">RobotCleaner</button>
                                    <button class="w3-bar-item w3-button tablink" onclick="openTab(event,'Device5')">TV</button>
                                </div>

                                <div id="Device1" class="tab" style="border: none; opacity: 1; height:300px;overflow:auto;">
                                </div>
                                <div id="Device2" class="tab" style="display:none; opacity: 1; height:300px;overflow:auto;">
                                </div>
                                <div id="Device3" class="tab" style="display:none">
                                </div>
                                <div id="Device4" class="tab" style="display:none">
                                </div>
                                <div id="Device5" class="tab" style="display:none">
                                </div>


                                <style>

                                path.line {
                                    fill: none;
                                    stroke: steelblue;
                                    stroke-width: 5px;
                                    opacity:0.6;
                                }

                                path.area {
                                    fill: #e7e7e7;
                                }

                                .axis {
                                    font: 16px sans-serif;
                                    shape-rendering: crispEdges;
                                }

                                .x.axis line {
                                    stroke: #000;
                                }

                                .x.axis .minor {
                                    stroke-opacity: .5;
                                }

                                .y.axis line, .y.axis path, .x.axis path{
                                    fill: none;
                                    stroke: #000;
                                }

                                .guideline {
                                    margin-right: 100px;
                                    float: right;
                                }

                                .legend rect {
                                    fill: white;
                                    stroke: grey;
                                    stroke-width: 0.7px;
                                }

                                .overlay {
                                    fill: none;
                                    pointer-events: all;
                                }

                                .hover-line {
                                    stroke: #B74779;
                                    stroke-width: 2px;
                                    stroke-dasharray: 3,3;
                                }
                            </style>
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>

                            <script>
                                var margin = {top: 30, right: 60, bottom: 30, left: 40},
                                width = (1160 - margin.left - margin.right)/2,
                                height = (520 - margin.top - margin.bottom)/2;

                                var parseDate = d3.time.format("%H:%M").parse;

                                var x = d3.time.scale()
                                .range([0, width]);

                                var posData=[
                                {x:18, y:10},
                                {x:25, y:230},
                                {x:28, y:519},
                                {x:29, y:30},
                                {x:31, y:120},
                                {x:40, y:2240}
                                ];
                                var xMax=d3.max( posData, function(d) {
                                    return d.x;
                                });

                                var xScale=d3.scale.linear()
                                .domain([18, xMax])
                                .range([0, width]);

                                        //                                        var xScaleTemp = d3.scale().linear().domain([18,40]).range([0, width]);

                                        var y = d3.scale.linear()
                                        .range([height, 0]);

                                        var y2 = d3.scale.linear()
                                        .range([height, 0]);

                                        var xAxis = d3.svg.axis()
                                        .scale(x)
                                        .orient("bottom")
                                        .tickFormat(d3.time.format("%H:%M"));

                                        var xAxis2 = d3.svg.axis()
                                        .scale(xScale)
                                            //.scale(xScaleTemp)
                                            .ticks(10)
                                            .orient("bottom")
                                            .tickFormat(function(d) { return d + '°C'});

                                            var yAxis = d3.svg.axis()
                                            .scale(y)
                                            .tickFormat(function(d) { return d + '°C'})
                                            .tickSize(10)
                                            .orient("left");

                                            var yAxis2 = d3.svg.axis()
                                            .scale(y)
                                            .tickFormat("")
                                            .tickSize(0)
                                            .orient("left");

                                        // An area generator, for the light fill.
                                        var area = d3.svg.area()
                                        .interpolate("monotone")
                                        .x(function(d) { return x(d.date); })
                                        .y0(height)
                                        .y1(function(d) { return y(d.counts); });

                                        var line = d3.svg.line()
                                        .interpolate("basis")
                                            //.defined(function(d) { return d.counts != 0; })
                                            .x(function(d) { return x(d.date); })
                                            .y(function(d) { return y(d.counts); });

                                            var svg = d3.select("#Device1").append("svg")
                                            .attr("width", width + margin.left + margin.right)
                                            .attr("height", height + margin.top + margin.bottom)
                                            .append("g")
                                            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                                        // @jaeseung : need to change value to approporiate position

                                        d3.tsv("{% static 'tsvSet/airconditioner_step.tsv' %}",
                                            function(error, data) {
                                                var color = d3.scale.category10();
                                                color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));

                                                data.forEach(function(d) {
                                                    d.date = +d.date;
                                                });

                                                var intentions = color.domain().map(function(name) {
                                                    return {
                                                        name: name,
                                                        values: data.map(function(d) {
                                                            return {date: d.date, counts: +d[name]};
                                                        })
                                                    };
                                                });

                                                // Set x and y range
                                                x.domain(d3.extent(data, function(d) { return d.date; }));

                                                y.domain([
                                                    d3.min(intentions, function(c) {
                                                        return d3.min(c.values, function(v)
                                                            { return v.counts; }); }),
                                                    d3.max(intentions, function(c) {
                                                        return d3.max(c.values, function(v)
                                                            { return v.counts+100; }); })
                                                    ]);

                                                // Add the clip path.
                                                svg.append("clipPath")
                                                .attr("id", "clip")
                                                .append("rect")
                                                .attr("width", width)
                                                .attr("height", height);

                                                // x axis
                                                svg.append("g")
                                                .attr("class", "x axis")
                                                .attr("transform", "translate(0," + height + ")")
                                                .style("font-size", "10px")
                                                .call(xAxis2)
                                                .append("text")
                                                .attr("transform", "translate(" + width + ",0)")
                                                .attr("y", 10)
                                                .attr("dy", "1.5em")
                                                .attr("dx", "-1em")
                                                .style("font-size", "12px")
                                                .text("Temperature");

                                                // y axis
                                                svg.append("g")
                                                .attr("class", "y axis")
                                                .attr("transform", "translate(" + width + ",0)")
                                                .attr("transform", "rotate(0)")
                                                .style("font-size", "10px")
                                                .call(yAxis2)
                                                .append("text")
                                                .attr("transform", "rotate(-90)")
                                                .attr("y", -6)
                                                .attr("dy", "-0.75em")
                                                .style("text-anchor", "end")
                                                .text("ON/OFF");

                                                // Title
                                                /*
                                                svg.append("text")
                                                    .attr("x", (width / 2))
                                                    .attr("y", 0 - (margin.top/10))
                                                    .attr("text-anchor", "middle")
                                                    .style("font-size", "15px")
                                                    .text("Daily Temperature");
                                                    */

                                                    var intention = svg.selectAll(".intention")
                                                    .data(intentions)
                                                    .enter().append("g")
                                                    .attr("class", "intention");

                                                    intention.append("path")
                                                    .attr("class", "line")
                                                    .style("stroke", function(d) { return color(d.name); })
                                                    .attr('clip-path', 'url(#clip)')
                                                    .attr("d", function(d) { return line(d.values); })
                                                    .attr("data-legend",function(d) { return d.name})

                                                /*
                                                intention.append("text")
                                                    .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
                                                    .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.counts) + ")"; })
                                                    .attr("x", 3)
                                                    .attr("dy", ".35em")
                                                    .style("font-size", "10px")
                                                    .text(function(d) { return d.name; });
                                                    */
                                                });


                                            </script>

                                            <script>
                                                var margin = {top: 30, right: 60, bottom: 30, left: 40},
                                                width = (1160 - margin.left - margin.right)/2,
                                                height = (520 - margin.top - margin.bottom)/2;

                                                var parseDate = d3.time.format("%H:%M").parse;

                                                var x = d3.time.scale()
                                                .range([0, width]);

                                                var posData2=[
                                                {x:0, y:10},
                                                {x:100, y:2240}
                                                ];
                                                var xMax2=d3.max( posData2, function(d) {
                                                    return d.x;
                                                });

                                                var xScale2 =d3.scale.linear()
                                                .domain([0, xMax2])
                                                .range([0, width]);
                                        //                                        var xScaleTemp = d3.scale().linear().domain([18,40]).range([0, width]);

                                        var y = d3.scale.linear()
                                        .range([height, 0]);

                                        var y2 = d3.scale.linear()
                                        .range([height, 0]);

                                        var xAxis = d3.svg.axis()
                                        .scale(x)
                                        .orient("bottom")
                                        .tickFormat(d3.time.format("%H:%M"));

                                        var xAxis3 = d3.svg.axis()
                                        .scale(xScale2)
                                            //.scale(xScaleTemp)
                                            .ticks(10)
                                            .orient("bottom")
                                            .tickFormat(function(d) { return d });

                                            var yAxis = d3.svg.axis()
                                            .scale(y)
                                            .tickFormat(function(d) { return d + '°C'})
                                            .tickSize(10)
                                            .orient("left");

                                            var yAxis2 = d3.svg.axis()
                                            .scale(y)
                                            .tickFormat("")
                                            .tickSize(0)
                                            .orient("left");

                                        // An area generator, for the light fill.
                                        var area = d3.svg.area()
                                        .interpolate("monotone")
                                        .x(function(d) { return x(d.date); })
                                        .y0(height)
                                        .y1(function(d) { return y(d.counts); });

                                        var line = d3.svg.line()
                                        .interpolate("basis")
                                            //.defined(function(d) { return d.counts != 0; })
                                            .x(function(d) { return x(d.date); })
                                            .y(function(d) { return y(d.counts); });

                                            var svg2 = d3.select("#Device2").append("svg")
                                            .attr("width", width + margin.left + margin.right)
                                            .attr("height", height + margin.top + margin.bottom)
                                            .append("g")
                                            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                                        // @jaeseung : need to change value to approporiate position

                                        d3.tsv("{% static 'tsvSet/aircleaner_step.tsv' %}",
                                            function(error, data) {
                                                var color = d3.scale.category10();
                                                color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));

                                                data.forEach(function(d) {
                                                    d.date = +d.date;
                                                });

                                                var intentions = color.domain().map(function(name) {
                                                    return {
                                                        name: name,
                                                        values: data.map(function(d) {
                                                            return {date: d.date, counts: +d[name]};
                                                        })
                                                    };
                                                });

                                                // Set x and y range
                                                x.domain(d3.extent(data, function(d) { return d.date; }));

                                                y.domain([
                                                    d3.min(intentions, function(c) {
                                                        return d3.min(c.values, function(v)
                                                            { return v.counts; }); }),
                                                    d3.max(intentions, function(c) {
                                                        return d3.max(c.values, function(v)
                                                            { return v.counts+100; }); })
                                                    ]);

                                                // Add the clip path.
                                                svg2.append("clipPath")
                                                .attr("id", "clip")
                                                .append("rect")
                                                .attr("width", width)
                                                .attr("height", height);

                                                // x axis
                                                svg2.append("g")
                                                .attr("class", "x axis")
                                                .attr("transform", "translate(0," + height + ")")
                                                .style("font-size", "10px")
                                                .call(xAxis3)
                                                .append("text")
                                                .attr("transform", "translate(" + width + ",0)")
                                                .attr("y", 10)
                                                .attr("dy", "1.5em")
                                                .attr("dx", "-10em")
                                                .style("font-size", "12px")
                                                .text("Micro Dust Concentration(㎍/m³)");

                                                // y axis
                                                svg2.append("g")
                                                .attr("class", "y axis")
                                                .attr("transform", "translate(" + width + ",0)")
                                                .attr("transform", "rotate(0)")
                                                .style("font-size", "10px")
                                                .call(yAxis2)
                                                .append("text")
                                                .attr("transform", "rotate(-90)")
                                                .attr("y", -6)
                                                .attr("dy", "-0.75em")
                                                .style("text-anchor", "end")
                                                .text("ON/OFF");

                                                // Title
                                                /*
                                                svg.append("text")
                                                    .attr("x", (width / 2))
                                                    .attr("y", 0 - (margin.top/10))
                                                    .attr("text-anchor", "middle")
                                                    .style("font-size", "15px")
                                                    .text("Daily Temperature");
                                                    */

                                                    var intention = svg2.selectAll(".intention")
                                                    .data(intentions)
                                                    .enter().append("g")
                                                    .attr("class", "intention");

                                                    intention.append("path")
                                                    .attr("class", "line")
                                                    .style("stroke", function(d) { return color(d.name); })
                                                    .attr('clip-path', 'url(#clip)')
                                                    .attr("d", function(d) { return line(d.values); })
                                                    .attr("data-legend",function(d) { return d.name})

                                                /*
                                                intention.append("text")
                                                    .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
                                                    .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.counts) + ")"; })
                                                    .attr("x", 3)
                                                    .attr("dy", ".35em")
                                                    .style("font-size", "10px")
                                                    .text(function(d) { return d.name; });
                                                    */
                                                });
                                            </script>


                                            <script>
                                                var margin = {top: 30, right: 60, bottom: 30, left: 40},
                                                width = (1160 - margin.left - margin.right)/2,
                                                height = (520 - margin.top - margin.bottom)/2;

                                                var parseDate = d3.time.format("%H:%M").parse;

                                                var x = d3.time.scale()
                                            .range([0, width]); // @jaeseung : need to change

                                            var y = d3.scale.linear()
                                            .range([height, 0]);

                                            var xAxis = d3.svg.axis()
                                            .scale(x)
                                            .orient("bottom")
                                            .tickFormat(d3.time.format("%H:%M"));

                                            var yAxis = d3.svg.axis()
                                            .scale(y)
                                            .tickFormat(function(d) { return d + '°C'})
                                            .tickSize(10)
                                            .orient("left");

                                            var yAxis2 = d3.svg.axis()
                                            .scale(y2)
                                            .tickFormat("")
                                            .tickSize(0)
                                            .orient("left");

                                        // An area generator, for the light fill.
                                        var area = d3.svg.area()
                                        .interpolate("monotone")
                                        .x(function(d) { return x(d.date); })
                                        .y0(height)
                                        .y1(function(d) { return y(d.counts); });

                                        var line = d3.svg.line()
                                        .interpolate("basis")
                                            //.defined(function(d) { return d.counts != 0; })
                                            .x(function(d) { return x(d.date); })
                                            .y(function(d) { return y(d.counts); });

                                            var svg4 = d3.select("#Device3").append("svg")
                                            .attr("width", width + margin.left + margin.right)
                                            .attr("height", height + margin.top + margin.bottom)
                                            .append("g")
                                            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                                        // @jaeseung : need to change value to approporiate position

                                        d3.tsv("{% static 'tsvSet/bulb_after2.tsv' %}", function(error, data) {
                                            var color = d3.scale.category10();
                                            color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));

                                            data.forEach(function(d) {
                                                d.date = parseDate(d.date);
                                            });

                                            var intentions = color.domain().map(function(name) {
                                                return {
                                                    name: name,
                                                    values: data.map(function(d) {
                                                        return {date: d.date, counts: +d[name]};
                                                    })
                                                };
                                            });

                                            // Set x and y range
                                            x.domain(d3.extent(data, function(d) { return d.date; }));

                                            y.domain([
                                                d3.min(intentions, function(c) {
                                                    return d3.min(c.values, function(v)
                                                        { return v.counts; }); }),
                                                d3.max(intentions, function(c) {
                                                    return d3.max(c.values, function(v)
                                                        { return v.counts; }); })
                                                ]);

                                            // Add the clip path.
                                            svg4.append("clipPath")
                                            .attr("id", "clip")
                                            .append("rect")
                                            .attr("width", width)
                                            .attr("height", height);

                                            // x axis
                                            svg4.append("g")
                                            .attr("class", "x axis")
                                            .attr("transform", "translate(0," + height + ")")
                                            .style("font-size", "10px")
                                            .call(xAxis)
                                            .append("text")
                                            .attr("transform", "translate(" + width + ",0)")
                                            .attr("y", 10)
                                            .attr("dy", "0.75em")
                                            .attr("dx", "-1em")
                                            .style("font-size", "12px")
                                            .text("Time");

                                            // y axis
                                            svg4.append("g")
                                            .attr("class", "y axis")
                                            .attr("transform", "translate(" + width + ",0)")
                                            .attr("transform", "rotate(0)")
                                            .style("font-size", "10px")
                                            .call(yAxis2)
                                            .append("text")
                                            .attr("transform", "rotate(-90)")
                                            .attr("y", -6)
                                            .attr("dy", "-0.75em")
                                            .style("text-anchor", "end")
                                            .text("ON/OFF");
                                            // Title
                                            /*
                                            svg4.append("text")
                                                .attr("x", (width / 2))
                                                .attr("y", 0 - (margin.top/10))
                                                .attr("text-anchor", "middle")
                                                .style("font-size", "15px")
                                                .text("Daily Temperature");
                                                */

                                                var intention = svg4.selectAll(".intention")
                                                .data(intentions)
                                                .enter().append("g")
                                                .attr("class", "intention");

                                                intention.append("path")
                                                .attr("class", "line")
                                                .style("stroke", function(d) { return color(d.name); })
                                                .attr('clip-path', 'url(#clip)')
                                                .attr("d", function(d) { return line(d.values); })
                                                .attr("data-legend",function(d) { return d.name});

                                                intention.append("text")
                                                .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
                                                .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.counts) + ")"; })
                                                .attr("x", 3)
                                                .attr("dy", ".35em")
                                                .style("font-size", "10px")
                                                .text(function(d) { return d.name; });
                                            });

                                        </script>

                                        <script>
                                            var margin = {top: 30, right: 60, bottom: 30, left: 40},
                                            width = (1160 - margin.left - margin.right)/2,
                                            height = (520 - margin.top - margin.bottom)/2;

                                            var parseDate = d3.time.format("%H:%M").parse;

                                            var x = d3.time.scale()
                                            .range([0, width]); // @jaeseung : need to change

                                            var y = d3.scale.linear()
                                            .range([height, 0]);

                                            var xAxis = d3.svg.axis()
                                            .scale(x)
                                            .orient("bottom")
                                            .tickFormat(d3.time.format("%H:%M"));

                                            var yAxis = d3.svg.axis()
                                            .scale(y)
                                            .tickFormat(function(d) { return d + '°C'})
                                            .tickSize(10)
                                            .orient("left");

                                            var yAxis2 = d3.svg.axis()
                                            .scale(y2)
                                            .tickFormat("")
                                            .tickSize(0)
                                            .orient("left");

                                        // An area generator, for the light fill.
                                        var area = d3.svg.area()
                                        .interpolate("monotone")
                                        .x(function(d) { return x(d.date); })
                                        .y0(height)
                                        .y1(function(d) { return y(d.counts); });

                                        var line = d3.svg.line()
                                        .interpolate("basis")
                                            //.defined(function(d) { return d.counts != 0; })
                                            .x(function(d) { return x(d.date); })
                                            .y(function(d) { return y(d.counts); });

                                            var svg5 = d3.select("#Device4").append("svg")
                                            .attr("width", width + margin.left + margin.right)
                                            .attr("height", height + margin.top + margin.bottom)
                                            .append("g")
                                            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                                        // @jaeseung : need to change value to approporiate position

                                        d3.tsv("{% static 'tsvSet/robotcleaner_after2.tsv' %}", function(error, data) {
                                            var color = d3.scale.category10();
                                            color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));

                                            data.forEach(function(d) {
                                                d.date = parseDate(d.date);
                                            });

                                            var intentions = color.domain().map(function(name) {
                                                return {
                                                    name: name,
                                                    values: data.map(function(d) {
                                                        return {date: d.date, counts: +d[name]};
                                                    })
                                                };
                                            });

                                            // Set x and y range
                                            x.domain(d3.extent(data, function(d) { return d.date; }));

                                            y.domain([
                                                d3.min(intentions, function(c) {
                                                    return d3.min(c.values, function(v)
                                                        { return v.counts; }); }),
                                                d3.max(intentions, function(c) {
                                                    return d3.max(c.values, function(v)
                                                        { return v.counts; }); })
                                                ]);

                                            // Add the clip path.
                                            svg5.append("clipPath")
                                            .attr("id", "clip")
                                            .append("rect")
                                            .attr("width", width)
                                            .attr("height", height);

                                            // x axis
                                            svg5.append("g")
                                            .attr("class", "x axis")
                                            .attr("transform", "translate(0," + height + ")")
                                            .style("font-size", "10px")
                                            .call(xAxis)
                                            .append("text")
                                            .attr("transform", "translate(" + width + ",0)")
                                            .attr("y", 10)
                                            .attr("dy", "0.75em")
                                            .attr("dx", "-1em")
                                            .style("font-size", "12px")
                                            .text("Time");

                                            // y axis
                                            svg5.append("g")
                                            .attr("class", "y axis")
                                            .attr("transform", "translate(" + width + ",0)")
                                            .attr("transform", "rotate(0)")
                                            .style("font-size", "10px")
                                            .call(yAxis2)
                                            .append("text")
                                            .attr("transform", "rotate(-90)")
                                            .attr("y", -6)
                                            .attr("dy", "-0.75em")
                                            .style("text-anchor", "end")
                                            .text("ON/OFF");
                                            // Title
                                            /*
                                            svg5.append("text")
                                                .attr("x", (width / 2))
                                                .attr("y", 0 - (margin.top/10))
                                                .attr("text-anchor", "middle")
                                                .style("font-size", "15px")
                                                .text("Daily Temperature");
                                                */

                                                var intention = svg5.selectAll(".intention")
                                                .data(intentions)
                                                .enter().append("g")
                                                .attr("class", "intention");

                                                intention.append("path")
                                                .attr("class", "line")
                                                .style("stroke", function(d) { return color(d.name); })
                                                .attr('clip-path', 'url(#clip)')
                                                .attr("d", function(d) { return line(d.values); })
                                                .attr("data-legend",function(d) { return d.name});

                                                intention.append("text")
                                                .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
                                                .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.counts) + ")"; })
                                                .attr("x", 3)
                                                .attr("dy", ".35em")
                                                .style("font-size", "10px")
                                                .text(function(d) { return d.name; });
                                            });

                                        </script>

                                        <script>
                                            var margin = {top: 30, right: 60, bottom: 30, left: 40},
                                            width = (1160 - margin.left - margin.right)/2,
                                            height = (520 - margin.top - margin.bottom)/2;

                                            var parseDate = d3.time.format("%H:%M").parse;

                                            var x = d3.time.scale()
                                            .range([0, width]); // @jaeseung : need to change

                                            var y = d3.scale.linear()
                                            .range([height, 0]);

                                            var xAxis = d3.svg.axis()
                                            .scale(x)
                                            .orient("bottom")
                                            .tickFormat(d3.time.format("%H:%M"));

                                            var yAxis = d3.svg.axis()
                                            .scale(y)
                                            .tickFormat(function(d) { return d + '°C'})
                                            .tickSize(10)
                                            .orient("left");

                                            var yAxis2 = d3.svg.axis()
                                            .scale(y2)
                                            .tickFormat("")
                                            .tickSize(0)
                                            .orient("left");

                                        // An area generator, for the light fill.
                                        var area = d3.svg.area()
                                        .interpolate("monotone")
                                        .x(function(d) { return x(d.date); })
                                        .y0(height)
                                        .y1(function(d) { return y(d.counts); });

                                        var line = d3.svg.line()
                                        .interpolate("basis")
                                            //.defined(function(d) { return d.counts != 0; })
                                            .x(function(d) { return x(d.date); })
                                            .y(function(d) { return y(d.counts); });

                                            var svg6 = d3.select("#Device5").append("svg")
                                            .attr("width", width + margin.left + margin.right)
                                            .attr("height", height + margin.top + margin.bottom)
                                            .append("g")
                                            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                                        // @jaeseung : need to change value to approporiate position

                                        d3.tsv("{% static 'tsvSet/tv_new_after2.tsv' %}", function(error, data) {
                                            var color = d3.scale.category10();
                                            color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));

                                            data.forEach(function(d) {
                                                d.date = parseDate(d.date);
                                            });

                                            var intentions = color.domain().map(function(name) {
                                                return {
                                                    name: name,
                                                    values: data.map(function(d) {
                                                        return {date: d.date, counts: +d[name]};
                                                    })
                                                };
                                            });

                                            // Set x and y range
                                            x.domain(d3.extent(data, function(d) { return d.date; }));

                                            y.domain([
                                                d3.min(intentions, function(c) {
                                                    return d3.min(c.values, function(v)
                                                        { return v.counts; }); }),
                                                d3.max(intentions, function(c) {
                                                    return d3.max(c.values, function(v)
                                                        { return v.counts; }); })
                                                ]);

                                            // Add the clip path.
                                            svg6.append("clipPath")
                                            .attr("id", "clip")
                                            .append("rect")
                                            .attr("width", width)
                                            .attr("height", height);

                                            // x axis
                                            svg6.append("g")
                                            .attr("class", "x axis")
                                            .attr("transform", "translate(0," + height + ")")
                                            .style("font-size", "10px")
                                            .call(xAxis)
                                            .append("text")
                                            .attr("transform", "translate(" + width + ",0)")
                                            .attr("y", 10)
                                            .attr("dy", "0.75em")
                                            .attr("dx", "-1em")
                                            .style("font-size", "12px")
                                            .text("Time");

                                            // y axis
                                            svg6.append("g")
                                            .attr("class", "y axis")
                                            .attr("transform", "translate(" + width + ",0)")
                                            .attr("transform", "rotate(0)")
                                            .style("font-size", "10px")
                                            .call(yAxis2)
                                            .append("text")
                                            .attr("transform", "rotate(-90)")
                                            .attr("y", -6)
                                            .attr("dy", "-0.75em")
                                            .style("text-anchor", "end")
                                            .text("ON/OFF");
                                            // Title
                                            /*
                                            svg6.append("text")
                                                .attr("x", (width / 2))
                                                .attr("y", 0 - (margin.top/10))
                                                .attr("text-anchor", "middle")
                                                .style("font-size", "15px")
                                                .text("Daily Temperature");
                                                */

                                                var intention = svg6.selectAll(".intention")
                                                .data(intentions)
                                                .enter().append("g")
                                                .attr("class", "intention");

                                                intention.append("path")
                                                .attr("class", "line")
                                                .style("stroke", function(d) { return color(d.name); })
                                                .attr('clip-path', 'url(#clip)')
                                                .attr("d", function(d) { return line(d.values); })
                                                .attr("data-legend",function(d) { return d.name});

                                                intention.append("text")
                                                .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
                                                .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.counts) + ")"; })
                                                .attr("x", 3)
                                                .attr("dy", ".35em")
                                                .style("font-size", "10px")
                                                .text(function(d) { return d.name; });
                                            });

                                        </script>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>

            <!-- @jaeseung : 3. Interact Interface -->
            <div class="col-md-5" , style="border: hidden; min-height: 1000px;">
                {% csrf_token %}
                <div class="row" , style="margin-top: 0px; border: hidden; min-height: 1000px;">
                    <div class="col-md-12">
                        <div class="row" , style="border: hidden; min-height: 50px">
                            <div class="col-md-12">
                                <div class="panel panel-success" style="border: none;  opacity: 0.7">
                                    <div class="panel-heading" style="background-color: #3D495D; padding-bottom: 4px; border: none">
                                        <p style="color: aliceblue; font-size: 20px">
                                            <span class="glyphicon glyphicon-user"></span>
                                            Interact Interface
                                        </p>
                                    </div>

                                    <div class="panel-body"
                                    style="background-color: #FEFEFF; max-height: 335px; min-height: 335px; overflow:auto;"
                                    id="scroll_body">

                                    <div id="chat">

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row" , style="border: hidden; min-height: 30px;">
                        <div class="col-md-12">
                            <div class="form-group has-success has-feedback">
                                <div class="input-group">
                                    <span class="input-group-addon">스마트 미러 입력</span>

                                    <input type="text" class="form-control" id="inputGroupSuccess1"
                                    aria-describedby="inputGroupSuccess1Status" onkeydown="onKeyDown()">
                                    <!-- 채팅박스 -->


                                    {# <input type="submit" onclick=click() value="보내기"> #}
                                </div>
                                <span class="glyphicon glyphicon-ok form-control-feedback" aria-hidden="true"></span>
                                <span id="inputGroupSuccess1Status" class="sr-only"></span>
                            </div>
                        </div>
                    </div>


                    <!-- @jaeseung : 4. Device -->
                    <div class="row" , style="border: hidden; min-height: 350px;">
                        <div class="col-md-12">
                            <div class="panel"  style="border: none;  opacity: 0.7">
                                <div class="panel-heading" style="background-color: #3D495D; padding-bottom: 4px; border: none">
                                    <p style="color: aliceblue; font-size: 20px">
                                        <span class="glyphicon glyphicon-thumbs-up"></span> Device State
                                    </p>
                                </div>
                            <!-- @jaeseung : Unused Tab 
                            <div class="w3-bar w3-black">
                                <button class="w3-bar-item w3-button tablink w3-red" onclick="openTab(event,'Context1')">Context</button>
                                <button class="w3-bar-item w3-button tablink" onclick="openTab(event,'Context2')">Device</button>
                            </div>
                        -->
                        <div class="panel-body" style="min-height: 310px;max-height: 310px; background-color: #FFFFFF">
                        </div>
                    </div>
                </div>
            </div>

        </div>


    </div>
</div>


</div>
</div>

<script>
    ////// (start) for fix 403 forbiddon error //////////////////////////////////////////
    var csrftoken = $.cookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });
    ////// (end) for fix 403 forbiddon error //////////////////////////////////////////


    /**
     *  방범모드가 활성화되면 해당 Flag가 False로 바뀌면서 재입력되지 않음.
     대신 최종 결과가 나오고 하나의 Cycle이 끝나면 다시 true로 바껴서
     Motion Sensor의 값에 따라 다시 방범모드가 활성화 됨.
     **/
     var motionFlag = true;
     var beforeCommand = "";

     var comeHomeBeforeDay = "";
     var comeHomeBeforeFlag = true;

     var comeHomeDay = "";
     var comeHomeFlag = true;


    // Loading 되자마자 바로 실행되는 함수
    $(window).load(function() {
        // CPU TIME 읽어서 현재 시간 정보와 관련된 정보들을 JESS에 Fact들로 집어넣음
        var dt = new Date($.now());

        var hour = dt.getHours();
        var minute = dt.getMinutes();
        var month = dt.getMonth() + 1;

        console.log(month+"/"+hour+"/"+minute);

        // Set Contexts
        context = setContext(month, hour, minute);
        context.success(function() {
            console.log("Context Information Success!");
        });


        // 처음 로딩할 때 날씨 정보와 Temporal Context를 모두 불러온 후,
        // 15분마다 한번씩 갱신
        setWeatherData();
        setTemporalContextValue();

        // @jaeseung : 바른기술 측의 정보 제공 필요 
        // - 숭실대 코드만 사용 시 아래와 같이 주석처리
        {% comment %}
        // Initiate Server
        initServer = initServer();
        initServer.success(function() {
            console.log("Initiate Server Success!");
        });

        // Initiate Server for Input
        initInputServer = initInputServer();
        initInputServer.success(function() {
            console.log("Initiate Server for Input Success!");
        });
        {% endcomment %}

        // 시작하자마자 Door Sensor의 값을 받아와서 검사해야 함
        // 3초마다 한번씩 검사함
        setTimeout(function getMotionSensorValueEachTime () {
            checkMotionSensorValue();

            setTimeout(getMotionSensorValueEachTime, 1000 * 3);
        }, 1000 * 3);

        // 15분마다 한번씩 갱신
        setTimeout(function getWeatherDataFromServer () {
            setWeatherData();

            setTimeout(getWeatherDataFromServer, 1000 * 60 * 15);
        }, 1000 * 60 * 15);

        // 15분마다 한번씩 갱신
        setTimeout(function getTemporalContextData() {
            setTemporalContextValue();

            // 시스템의 날짜를 받아와서,
            // 귀가 전날 날짜와 일치할 경우,
            // 귀가전날 이라는 Butler Command를 입력하도록 설정함

            var dt = new Date($.now());

            var day = dt.getDate();

            if (day === comeHomeBeforeDay && comeHomeBeforeFlag === true) {

                var butlerCommand = "귀가전날";

                var commandAjax = setButlerCommand(butlerCommand);

                commandAjax.success(function()  {
                    console.log("Setting Butler Command Success!");
                    comeHomeBeforeFlag = false;
                });
            }

            if (day === comeHomeDay && comeHomeFlag === true) {
                var doorAjax = getDoorSensorValue();
                var doorValue = "";

                doorAjax.success(function(json) {

                    {#                    console.log("Get Door Sensor Value Success!");#}

                    $.each(json, function (key, value) {
                        if (key === 'Door') {
                            //Strip
                            doorValue = String(value).replace(/^\s+|\s+$/g, '');
                            console.log("Motion Value: " + doorValue);
                        }
                    });

                });

                if (doorValue === "OPEN") {
                    var butlerCommand2 = "귀가당일문열림";

                    var commandAjax2 = setButlerCommand(butlerCommand2);

                    commandAjax2.success(function()  {
                        console.log("Setting Butler Command Success!");
                        comeHomeFlag = false;
                    });

                }
            }

            setTimeout(getTemporalContextData, 1000 * 3);
        }, 1000 * 10);


        setTimeout(function fire() {
            var input_string = "";
            {#            console.log("Fire");#}

            // 바른기술측에서 넘어온 데이터를 받음
            getInput = getInputFromServer();
            getInput.success(function (json) {
                console.log("Get Input From Server Success!");

                $.each(json, function (key, value) {
                    console.log("Key: " + key);
                    console.log("Value: " + value);

                    if (key === 'Input') {
                        value = String(value).replace(/^\s+|\s+$/g, '');

                        // 전에 받은 명령과 비교해서 달라지면 실행되도록 설정
                        if (value !== "") {
                            if (beforeCommand === "" || value !== beforeCommand) {
                                console.log("Input In");
                                input_string = value;

                                executeButler(input_string);

                                beforeCommand = input_string;
                            }
                            else {
                                console.log("Duplicated Input");
                            }

                        }
                    }
                });
            });

            setTimeout(fire, 2 * 1000);
        }, 2 * 1000);
    });

var answer_set = [];
var question_case = "";

    /**
     * 웹 상에서 Key가 눌러졌을 때, 실행되는 함수
     **/
     function onKeyDown() {
        // 입력되는 Key가 Enter Key일 경우
        if (event.keyCode === 13) {

            var input_string = $('#inputGroupSuccess1').val();
            executeButler(input_string);
        }
    }

    /**
     * 웹 상에서 입력받은 정보가 프로그램 구동에 Valid한 정보인지를 판단하는 함수
     * 질문에 대한 Valid한 대답들이거나, 프로그램이 처음 구동하여 각종 모드들을 입력 받아야 하는 경우를 포함.
     *
     * input:
     *      - input: 웹 상에서 입력된 String
     *      - answerSet: 질문에 대한 Valid한 답변들이 들어있는 Array
     *
     * Return:
     *      Valid할 경우 True, 아닐 경우 False를 Return
     * */
     function checkValidInput(input, answerSet) {
        if (answerSet.length !== 0) {
            console.log(answerSet[1]);
            for (var i = 0; i < answerSet.length; i++) {
                if (input === answerSet[i]) {
                    return true;
                }
            }
        }
        else {
            if (input.includes("귀가") || input.includes("외출모드") || input.includes("문열림")
                || input.includes("안전모드") || input.includes("설정온도") || input.includes("절전모드")
                || input.includes("TV,전구제어") || input.includes("방범모드")) {
                return true;
        }
    }

    return false;
}


function executeButler(input_string) {
    if (input_string !== "") {
        parsed_input_string = "<div class=\"alert alert-info\" role=\"alert\">" + input_string + "</div>";

            // ajax 통신과 그 결과를 담을 변수
            var ajax_communication = null;
            var communicate_result = null;

            // Log 창에 뿌릴 정보를 담는 변수
            var new_string = "";

            // 기존의 내용들을 다 담음
            new_string = $('#chat').html() + parsed_input_string +"\n";
            // 숭실대측 Debug 창
            debug_string = $('#s_json_protocol').html() + "\n";
            // 바른기술 Output 창
            output_protocol = $('#json_protocol_out').html() + "\n";
            // 바른기술 Input 창
            input_protocol = $('#json_protocol').html() + "\n";

            /**
             * 웹 상에 입력되는 정보들이 프로그램에 Valid한 정보들인지 판단하여
             * Valid할 경우, 입력으로 사용됨.
             **/
             if (checkValidInput(input_string, answer_set)) {
                var code = "";
                var command = "";

                if (input_string.includes("외출모드")) {
                    command = input_string;
                    {#                        fireScenarioList(input_string);#}
                }
                else if (input_string.includes("방범모드")) {
                    command = input_string;
                }
                else {
                    console.log("Question Case: " + question_case);
                    command = input_string;
                }

                // CPU TIME을 읽어서 현재 시간 정보와 관련된 정보들을 JESS에 Fact들로 집어넣음
                var dt = new Date($.now());

                var hour = dt.getHours();
                var minute = dt.getMinutes();
                var month = dt.getMonth() + 1;
                var day = dt.getDay();

                ajax_communication = communicateAjaxWithCase(url="/smartButler/fire_rule/", question_case, command, hour, minute, month, day);
                ajax_communication.success(function(json) {
                    var return_string = "";

                    communicate_result = parse_json_result(json, debug_string, output_protocol, input_protocol);

                    console.log("Communicate Result: " + communicate_result + "Length: " + communicate_result.length);
                    if (communicate_result.length !== 0) {
                        return_string = "<div class=\"alert alert-warning\" role=\"alert\" align=\"right\">";

                        for (var i = 0; i < communicate_result.length; i++)
                            return_string += communicate_result[i];

                        return_string += "</div>";

                        new_string = new_string + return_string + "\n";
                    }
                });

                $('#chat').html(new_string);
                $('#inputGroupSuccess1').val('');
            }
            {#            // AnswerSet에 없는 입력일 경우에는 다시 되묻도록 설정#}
            {#            else {#}
            {#                var answer_string = "[";#}
            {##}
            {#                if (answer_set.length !== 0) {#}
            {#                    for (j = 0; j < answer_set.length; j++) {#}
            {#                        if (j === answer_set.length - 1) {#}
            {#                            answer_string += answer_set[j] + "]" + "중 하나만 입력가능합니다.";#}
            {#                        }#}
            {#                        else {#}
            {#                            answer_string += answer_set[j] + ", ";#}
            {#                        }#}
            {#                    }#}
            {#                }#}
            {#                else {#}
            {#                    answer_string += "다른 명령을 내려주세요.]"#}
            {#                }#}
            {##}
            {#                return_string = "<div class=\"alert alert-warning\" role=\"alert\" align=\"right\">" + answer_string + "</div>";#}
            {#                new_string += return_string + "\n";#}
            {#            }#}

            // 결과로 받은 정보들을 다시 웹 상의 Component 들에 출력하는 부분

        }
        // Scroll Height Auto Focusing
        $('#scroll_body').scrollTop($('#scroll_body').prop("scrollHeight"));
        $('#s_json_scroll').scrollTop($('#s_json_scroll').prop("scrollHeight"));
        $('#json_protocol').scrollTop($('#json_protocol').prop("scrollHeight"));
        $('#json_protocol_out').scrollTop($('#json_protocol_out').prop("scrollHeight"));
    }


    /**
     *  UI에 Weather Data를 출력해줌
     *
     * */
     function setWeatherData() {
        var weatherData = getWeatherData();

        var cloud = "";
        var rainProb = "";
        var humidity = "";
        var temperature = "";
        var rain = "";

        weatherData.success(function (json) {
            $.each(json, function (key, value) {
                // Strip
                value = String(value).replace(/^\s+|\s+$/g, '');

                if (key === 'Cloud') {
                    if (value === '맑음') {
                        cloud = "<img src=\"{% static 'weather/weather_sunny.png' %}\" style=\"width: 80%\">";
                    }
                    else if (value === '구름 조금') {
                        cloud = "<img src=\"{% static 'weather/weather_cloud_little.png' %}\" style=\"width: 80%\">";
                    }
                    else if (value === '구름 많음') {
                        cloud = "<img src=\"{% static 'weather/weather_cloud_much.png' %}\" style=\"width: 80%\">";
                    }
                    else if (value === '흐림') {
                        cloud = "<img src=\"{% static 'weather/weather_dark.png' %}\" style=\"width: 80%\">";
                    }
                }
                else if (key === 'RainProb') {
                    rainProb = "<p style=\"color: #2E86C1; font-size: 15px; margin-top:20px; margin-left:25px\">" + "강수확률 " + value + " %" + "</p>";
                    console.log("Rain Prob Value: " + value);
                }
                else if (key === 'Humidity') {
                    console.log("Humidity Value: " + value);

                    humidity = "<p style=\"color: #2E86C1; font-size: 13px; margin-top: 8px\">" + "습도<br>" + value + " %" + "</p>";
                }
                else if (key === 'Temperature') {
                    console.log("Temperature Value: " + value);
                    temperature = "<p style=\"color: #2E86C1; font-size: 30px; margin-top:20px; margin-left:40px\">" + value + "&degC</p>"
                }
                else if (key === 'Rain') {
                    console.log("Rain Value: " + value);

                    if (value === '비') {
                        cloud = "<img src=\"{% static 'weather/weather_rain.png' %}\" style=\"width: 80%\">";
                    }
                    else if (value === "진눈개비" || value === "눈") {
                        cloud = "<img src=\"{% static 'weather/weather_snow.png' %}\" style=\"width: 80%\">";
                    }
                }
            });
        });

        $('#rain_prob').html(rainProb);
        $('#weather_icon').html(cloud);
        $('#humidity_column').html(humidity);
        $('#temperature').html(temperature);
    }



    /**
     * JESS Engine이 구동하여 도출된 결과를 받아
     * 웹 상에 출력할 수 있도록 Parsing 하여 출력하는 함수
     *
     * input:
     *      - json: JESS Engine이 구동하여 도출된 결과들을 담고 있는 JSON 형태의 변수
     *      - debugString: 웹의 Debug Frame의 주소를 담고 있는 변수
     *      - outputProtocol: 웹의 Output Protocol Frame의 주소를 담고 있는 변수
     *      - inputProtocol: 웹의 Input Protocol Frame의 주소를 담고 있는 변수
     *
     * Return:
     *      스마트 미러와의 통신 결과를 보여주는 Frame에 출력할 정보들을 담고 있는 변수
     * */
     function parse_json_result(json, debugString, outputProtocol, inputProtocol) {
        var protocol = [];
        var results = [];
        var recommend = [];
        var inProtocol = [];
        var outProtocol = [];

        answer_set = [];
        question_case = "";

        $.each(json, function (key, value) {
            if (key === 'Debug') {
                $.each(value, function(key2, value2) {
                    protocol.push("<p>" + value2 + "</p>");
                });
            }
            else if (key === 'questionCase') {
                $.each(value, function(key2, value2) {
                    question_case = value2;
                });
            }
            else if (key === 'answerSet') {
                $.each(value, function(key2, value2) {
                    console.log("Answer Set Push: " + value2);
                    answer_set.push(value2);
                });
            }
            else if (key === 'Question') {
                {#                results = results + value + "\n";#}
                console.log("Question: " + value);
                $.each(value, function(key2, value2) {
                    results.push("<p>" + value2 + "</p>");
                });
            }
            else if (key === 'Result') {
                // Object to String Convert
                var value_string = value + '';
                var values = value_string.split(',');

                for (var i = 0; i < values.length; i++) {
                    results.push("<p>" + values[i] + "</p>");

                    if (values[i].includes("외출 중 청소 예약이")) {
                        var dt = new Date($.now());

                        // 외출 중 청소 예약이라는 키워드가 있을 경우,
                        // 4일 뒤에 해당 동작을 수행하도록 4일 뒤 날짜를 미리 저장해놓고,
                        // Temporal Context를 받을 때, 조건문에 검사되도록 설정
                        var day = dt.getDate();
                        comeHomeDay = day + 5;
                        comeHomeBeforeDay = day + 4;

                        console.log("Come Home Before Day: " + comeHomeBeforeDay);
                        console.log("Come Home Day: " + comeHomeDay);

                        comeHomeBeforeFlag = true;
                        comeHomeFlag = true;
                        motionFlag = true;
                    }
                }
            }
            // Recommend 출력하는 부분
            else if (key === "Recommend_without_json") {
                recommend.push("<table>");

                var jsonLength = value.length;
                var trCount = jsonLength / 4;

                var tdCount = 0;
                var trNeededCount = 0;

                var trClosed = false;
                var tdCountSplit = 3;

                $.each(value, function(key2, value2) {
                    console.log("Key: " + key2);
                    console.log("Value: " + value2);

                    var state = value2.split(":");

                    if (tdCount % tdCountSplit === 0 && trClosed === false) {
                        recommend.push("<tr>");
                        trClosed = true;
                    }

                    if (state[0].includes("Hue")) {
                        if (state[1].includes("100")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartLight/Smart조명_Green.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>")
                        }
                        else if (state[1].includes("0")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartLight/Smart조명_Gray.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>")
                        }
                    }
                    else if (state[0].includes("TV")) {
                        if (state[1].includes("PowerOn")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartTV/SmartTV_Green.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>");
                        }
                        else if (state[1].includes("PowerOff")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartTV/SmartTV_Gray.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>");
                        }
                    }
                    else if (state[0].includes("청소기")) {
                        if (state[1].includes("dock")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartCleaner/Smart청소기_Gray.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>");
                        }
                        else if (state[1].includes("vacuum")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartCleaner/Smart청소기_Green.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>");
                        }
                        else if (state[1].includes("예약모드")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartCleaner/Smart청소기_Yellow.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>");
                        }
                    }
                    else if (state[0].includes("보일러")) {
                        if (state[1].includes("ON") || state[1].includes("설정온도")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartBoiler/Smart보일러_Green.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>");
                        }
                        else if (state[1].includes("OFF")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartBoiler/Smart보일러_Gray.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>");
                        }
                        else if (state[1].includes("외출모드")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartBoiler/Smart보일러_Yellow.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>");
                        }
                    }
                    else if (state[0].includes("플러그")) {
                        if (state[1].includes("ON")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartPlug/SmartPlug_Green.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>");
                        }
                        else if (state[1].includes("OFF")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartPlug/SmartPlug_Gray.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>");
                        }
                    }
                    else if (state[0].includes("공기청정기")) {
                        if (state[1].includes("ON")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartAirCleaner/공기청정기_Green.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>");
                        }
                        else if (state[1].includes("OFF")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartAirCleaner/공기청정기_Gray.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>");
                        }
                        else if (state[1].includes("예약모드")) {
                            recommend.push("<td><img src=\"{% static 'device_image/SmartAirCleaner/공기청정기_Yellow.png' %}\"  alt=\"Cinque11 Terre\" style=\"width: 70%\"></td>");
                        }
                    }

                    {#                    recommend.push("<p>" + value2 + "</p>");#}

                    tdCount += 1;

                    if (tdCount % tdCountSplit === 0 && trClosed === true) {
                        recommend.push("</tr>");
                        trClosed = false;
                    }
                });

if (tdCount % tdCountSplit !== 0) {
    recommend.push("</tr>");
}

recommend.push("</table>")
}
else if (key === 'Response') {
    $.each(value, function(key2, value2) {
        inProtocol.push("<p> <b>In: </b>" + value2 + "</p>");
    });
}
else if (key === 'Out') {
    $.each(value, function(key2, value2) {
        outProtocol.push("<p> <b>Out: </b>" + value2 + "</p>");
    });
}
else if (key === "In") {
    $.each(value, function(key2, value2) {
        inProtocol.push("<p> <b>In: </b>" + value2 + "</p>");
    });
}

});

protocol.push("<p><b>---------------------------------------------</b>" + "</p>");

if (outProtocol.length !== 0)
    outProtocol.push("<p><b>---------------------------------------------</b>" + "</p>");

if (inProtocol.length !== 0)
    inProtocol.push("<p><b>---------------------------------------------</b>" + "</p>");

        // 배열 처음에 Push
        protocol.unshift(debugString);
        outProtocol.unshift(outputProtocol);
        inProtocol.unshift(inputProtocol);

        // For Internal Info
        $('#s_json_protocol').html(protocol);
        $('#butler_recommend_side').html(recommend);
        $('#json_protocol_out').html(outProtocol);
        $('#json_protocol').html(inProtocol);

        return results;
    }

    /**
     * django의 view 파일과 통신하기 위해 필요한 함수.
     * ajax로 통신하기 때문에, POST 형태의 통신 방식을 취하고 있으며
     * 스마트미러로부터 받은 입력과 그에 따른 사용자의 답변 Case,
     * 시스템으로부터 얻은 시간 정보들을 모두 담고 있다.
     *
     * input:
     *      - url: django의 view 파일과 ajax로 통신하기 위한 주소를 담고 있는 변수
     *      - answerCase: 사용자의 답변이 어떤 질문 Case에 대한 정보인지를 담고 있는 변수
     *      - code: 사용자가 프로그램을 처음 구동하여 각종 모드들을 입력할 경우, 그에 대응하는
     *              Code의 정보를 담고 있는 변수
     *      - command: 사용자의 답변 정보를 담고 있는 변수
     *      - hour: 시스템으로부터 얻은 '시' 정보를 담고 있는 변수
     *      - minute: 시스템으로부터 얻은 '분' 정보를 담고 있는 변수
     *      - month: 시스템으로부터 얻은 '월' 정보를 담고 있는 변수
     *      - day: 시스템으로부터 얻은 '일' 정보를 담고 있는 변수
     *
     * Return:
     *      통신에 성공할 경우, Success와 함께 JESS Engine 구동 결과들을 담고 있는
     *      Dictionary 형태의 변수와 함께 Return
     * */
     function communicateAjaxWithCase(url, answerCase, command, hour, minute, month, day) {
        console.log("Ajax Communication Check Working: " + url);

        return $.ajax({
            url: url,
            type: "POST",
            data: {
                answerCase: answerCase,
                command: command,
                hour: hour,
                minute: minute,
                month: month,
                day: day
            },
            async: false
        });
    }


    function initServer() {
        console.log("Server is Initiated");

        return $.ajax({
            url: "/smartButler/init_server/",
            type: "POST"
        });
    }

    function initInputServer() {
        console.log("Server for Input is Initiated");

        return $.ajax({
            url: "/smartButler/init_server_input/",
            type: "POST"
        });

    }


    function getInputFromServer() {
        {#console.log("Get Input From Server");#}

        return $.ajax({
            url: "/smartButler/get_input/",
            type: "POST",
            async: false
        });
    }


    function setTemporalContextValue() {
        {#        console.log("Get Temporal Context and Set Success");#}

        var dt = new Date($.now());

        var hour = dt.getHours();
        var month = dt.getMonth() + 1;
        var day = dt.getDay();

        var season = "";
        var date = "";
        var time = "";

        if (4 <= month && month <= 5) {
            season = "<p style=\"color: #2E86C1; font-size: 13px; margin-top: 8px\">봄</p>";
        }
        else if (6 <= month && month <= 9) {
            season = "<p style=\"color: #2E86C1; font-size: 13px; margin-top: 8px\">여름</p>";
        }
        else if (month === 10) {
            season = "<p style=\"color: #2E86C1; font-size: 13px; margin-top: 8px\">가을</p>";
        }
        else {
            season = "<p style=\"color: #2E86C1; font-size: 13px; margin-top: 8px\">겨울</p>";
        }

        if (0 <= hour && hour <= 10) {
            date = "<p style=\"color: #2E86C1; font-size: 13px; margin-top: 8px\">아침</p>";
        }
        else if (11 <= hour && hour <= 15) {
            date = "<p style=\"color: #2E86C1; font-size: 13px; margin-top: 8px\">점심</p>";
        }
        else if (16 <= hour && hour <= 24) {
            date = "<p style=\"color: #2E86C1; font-size: 13px; margin-top: 8px\">저녁</p>";
        }

        if (day <= 5) {
            time = "<p style=\"color: #2E86C1; font-size: 13px; margin-top: 8px\">주중</p>";
        }
        else if (day >= 6) {
            time = "<p style=\"color: #2E86C1; font-size: 13px; margin-top: 8px\">주말</p>";
        }

        $('#season_column').html(season);
        $('#date_column').html(date);
        $('#time_column').html(time);
    }


    /**
     *  Motion Sensor Value를 Check
     *  ON 이면 Butler Command를 방범모드로 설정
     *
     * */
     function checkMotionSensorValue() {
        var motionAjax = getMotionSensorValue();

        // 성공 했다면
        motionAjax.success(function(json) {
            {#            console.log("Get Motion Sensor Value Success!");#}

            var motionValue = "";

            $.each(json, function (key, value) {
                if (key === 'Motion') {
                    //Strip
                    motionValue = String(value).replace(/^\s+|\s+$/g, '');
                    {#                    console.log("Motion Value: " + motionValue);#}
                }
            });

            // 동작이 감지 되었다면
            // 방범모드를 Butler에게 명령한다.
            if (motionValue === 'ON') {
                console.log("Motion Value is ON");

                butlerCommand = "방범모드";

                // 들어온 후 한번만 명령어를 수정함
                if (motionFlag === true) {
                    var commandAjax = setButlerCommand(butlerCommand);

                    commandAjax.success(function()  {
                        console.log("Setting Butler Command Success!");
                        motionFlag = false;
                    });
                }
                else {
                    console.log("Motion Flag is not true");
                }
            }
            // 방범모드종료
            else if (motionValue === 'OFF' && motionFlag === false) {
                console.log("Motion Value is OFF and 방범모드종료");

                butlerCommand = "방범모드종료";
                var commandAjax2 = setButlerCommand(butlerCommand);

                commandAjax2.success(function()  {
                    console.log("Setting Butler Command Success!");
                    motionFlag = true;
                });
            }
            else {
                {#                console.log("Else Case Motion Value is " + motionValue);#}
            }
        });
    }

    /**
     *  서버로부터 Motion Sensor 정보를 받아옴
     *
     * */
     function getMotionSensorValue() {
        {#console.log("Get Motion Sensor Value From OpenHAB");#}

        return $.ajax({
            url: "/smartButler/get_motion_value/",
            type: "POST",
            async: false
        });
    }


    /**
     *  서버로부터 Door Sensor 정보를 받아옴
     *
     * */
     function getDoorSensorValue() {
        return $.ajax({
            url: "/smartButler/get_door_value/",
            type: "POST",
            async: false
        });
    }

    /**
     *  특정 조건에 의해 Butler Input이 수정되는 경우
     *  View 파일의 Command 변수에 값을 수정해준다.
     **/
     function setButlerCommand(butlerCommand) {
        {#console.log("Set Butlor");#}

        return $.ajax({
            url: "/smartButler/set_butler_command/",
            type: "POST",
            data: {
                command: butlerCommand
            },
            async: false
        });
    }


    function getWeatherData() {
        return $.ajax({
            url: "/smartButler/get_weather_data/",
            type: "POST",
            async: false
        });
    }

    /**
     * 시스템으로부터 얻은 월, 시, 분 정보들을 ajax로 통신하여 view 파일로 보내
     * Parsing 한 결과를 받는 함수
     *
     * input:
     *      - month: 시스템으로부터 얻은 '월' 정보를 담고 있는 변수
     *      - hour: 시스템으로부터 얻은 '시' 정보를 담고 있는 변수
     *      - minute: 시스템으로부터 얻은 '분' 정보를 담고 있는 변수
     *
     * Return:
     *      통신에 성공할 경우, Success와 함께 계절 정보를 비롯한 Parsing된 시간 정보들이 Return
     * */
     function setContext(month, hour, minute) {
        console.log("Context Information Working!");

        return $.ajax({
            url: "/smartButler/set_context/",
            type: "POST",
            data: {
                month: month,
                hour: hour,
                minute: minute
            },
            async: false
        });
    }

    // @jaeseung : Tab activate function
    function openTab(evt, tabName) {
        var i, x, tablinks;
        x = document.getElementsByClassName("tab");
        for (i = 0; i < x.length; i++) {
            x[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablink");
        for (i = 0; i < x.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" w3-red", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " w3-red";
    }
</script>
</body>
</html>